-- IkanTongkol.lua
-- Full-featured UI library with Minimize + Logo (Close tetap bekerja)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

local IkanTongkol = {}
IkanTongkol.__index = IkanTongkol

-- Utilities
local function new(class, props, parent)
    local inst = Instance.new(class)
    if props then
        for k,v in pairs(props) do inst[k] = v end
    end
    if parent then inst.Parent = parent end
    return inst
end

local function tween(inst, props, time, style, dir)
    time = time or 0.22
    style = style or Enum.EasingStyle.Quad
    dir = dir or Enum.EasingDirection.Out
    local t = TweenService:Create(inst, TweenInfo.new(time, style, dir), props)
    t:Play()
    return t
end

local function clamp(v,a,b) return math.max(a,math.min(b,v)) end

-- Persistent store
local function getStoreFolder()
    local pg = LocalPlayer:FindFirstChild("PlayerGui") or LocalPlayer:WaitForChild("PlayerGui")
    local folder = pg:FindFirstChild("IkanTongkolStore")
    if not folder then
        folder = Instance.new("Folder")
        folder.Name = "IkanTongkolStore"
        folder.Parent = pg
    end
    return folder
end

local function saveFlag(flag, value)
    local folder = getStoreFolder()
    local key = folder:FindFirstChild(flag)
    if not key then
        key = Instance.new("StringValue")
        key.Name = flag
        key.Parent = folder
    end
    key.Value = HttpService:JSONEncode(value)
end

local function loadFlag(flag)
    local folder = getStoreFolder()
    local key = folder:FindFirstChild(flag)
    if not key then return nil end
    local ok,val = pcall(HttpService.JSONDecode,HttpService,key.Value)
    if ok then return val else return nil end
end

-- CreateWindow
function IkanTongkol:CreateWindow(cfg)
    cfg = cfg or {}
    local self = setmetatable({},IkanTongkol)

    local gui = new("ScreenGui", {Name = cfg.Name or "IkanTongkolUI", ResetOnSpawn=false, ZIndexBehavior=Enum.ZIndexBehavior.Global}, LocalPlayer:WaitForChild("PlayerGui"))

    -- Main frame
    local main = new("Frame", {
        Name = "Main",
        AnchorPoint = Vector2.new(0.5,0.5),
        Position = UDim2.new(0.5,0,0.5,0),
        Size = cfg.Size or UDim2.new(0.36,0,0.56,0),
        BackgroundColor3 = cfg.BackgroundColor or Color3.fromRGB(28,28,30),
        BorderSizePixel = 0,
    }, gui)
    new("UICorner",{CornerRadius=UDim.new(0,12)},main)
    new("UIStroke",{Color=Color3.fromRGB(50,50,56),Thickness=1},main)

    -- Topbar
    local top = new("Frame",{Name="Topbar", Size=UDim2.new(1,0,0,44), BackgroundColor3=Color3.fromRGB(34,34,36)},main)
    new("UICorner",{CornerRadius=UDim.new(0,12)},top)

    local title = new("TextLabel",{
        Name="Title", BackgroundTransparency=1,
        Position=UDim2.new(0,12,0,8), Size=UDim2.new(1,-100,0,28),
        Text=cfg.Title or (cfg.Name or "Ikan Tongkol"),
        TextColor3=Color3.fromRGB(235,235,240),
        Font=Enum.Font.GothamBold, TextSize=16, TextXAlignment=Enum.TextXAlignment.Left
    },top)

    -- Close
    local closeBtn = new("TextButton",{
        Name="Close", BackgroundTransparency=0.6, Size=UDim2.new(0,36,0,28),
        Position=UDim2.new(1,-46,0,8), Text="✕", Font=Enum.Font.GothamBold, TextSize=16,
        TextColor3=Color3.fromRGB(240,80,80), AutoButtonColor=false, ZIndex=5
    },top)
    new("UICorner",{CornerRadius=UDim.new(0,8)},closeBtn)

    -- Minimize
    local minimizeBtn = new("TextButton",{
        Name="Minimize", BackgroundTransparency=0.3, Size=UDim2.new(0,36,0,28),
        AnchorPoint=Vector2.new(1,0), Position=UDim2.new(1,-90,0,8),
        Text="─", Font=Enum.Font.GothamBold, TextSize=16, TextColor3=Color3.fromRGB(255,255,255), AutoButtonColor=false, ZIndex=5
    },top)
    new("UICorner",{CornerRadius=UDim.new(0,8)},minimizeBtn)

    -- Sidebar + Content
    local sidebar = new("Frame", {Name="Sidebar", Position=UDim2.new(0,0,0,44), Size=UDim2.new(0,160,1,-44), BackgroundColor3=Color3.fromRGB(30,30,32)},main)
    new("UICorner",{CornerRadius=UDim.new(0,0)},sidebar)
    local tabsHolder = new("UIListLayout",{FillDirection=Enum.FillDirection.Vertical, Padding=UDim.new(0,8)},sidebar)
    new("UIPadding",{PaddingTop=UDim.new(0,8), PaddingLeft=UDim.new(0,8), PaddingRight=UDim.new(0,8)},sidebar)

    local content = new("Frame",{Name="Content", Position=UDim2.new(0,160,0,44), Size=UDim2.new(1,-160,1,-44), BackgroundColor3=Color3.fromRGB(26,26,28)},main)
    new("UICorner",{CornerRadius=UDim.new(0,0)},content)

    local pages = new("Folder",{Name="Pages"},content)

    -- Drag main window
    do
        local dragging, dragStart, startPos
        top.InputBegan:Connect(function(input)
            if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
                dragging=true; dragStart=input.Position; startPos=main.Position
                input.Changed:Connect(function()
                    if input.UserInputState==Enum.UserInputState.End then dragging=false end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
                local delta=input.Position-dragStart
                main.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X, startPos.Y.Scale,startPos.Y.Offset+delta.Y)
            end
        end)
    end

    -- Logo ikan
    local logoBtn = new("ImageLabel",{
        Size=UDim2.new(0,50,0,50), Position=UDim2.new(0,50,0,100),
        BackgroundTransparency=1, Image="rbxassetid://13803683727", Visible=false, ZIndex=6
    },LocalPlayer.PlayerGui)

    local mainPos = main.Position

    -- Minimize logic
    minimizeBtn.MouseButton1Click:Connect(function()
        tween(main, {Position=UDim2.new(0.5,0,-1,0)},0.22)
        logoBtn.Visible = true
    end)

    logoBtn.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 then
            tween(main, {Position=mainPos},0.22)
            logoBtn.Visible=false
        end
    end)

    -- Drag logo
    do
        local dragging, dragStart, startPos
        logoBtn.InputBegan:Connect(function(input)
            if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
                dragging=true; dragStart=input.Position; startPos=logoBtn.Position
                input.Changed:Connect(function()
                    if input.UserInputState==Enum.UserInputState.End then dragging=false end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
                local delta=input.Position-dragStart
                logoBtn.Position=UDim2.new(startPos.X.Scale,startPos.X.Offset+delta.X, startPos.Y.Scale,startPos.Y.Offset+delta.Y)
            end
        end)
    end

    -- Close logic
    closeBtn.MouseButton1Click:Connect(function()
        tween(main, {Size=UDim2.new(0,0,0,0)},0.22)
        task.delay(0.22,function() gui:Destroy() end)
    end)

    -- Store references
    self._gui = gui
    self._main = main
    self._sidebar = sidebar
    self._content = content
    self._pages = pages
    self._tabs = {}
    self._activeTab = nil
    self._notifFolder = new("Folder",{Name="Notifications"},main)

    -- Fitur lain: CreateTab, CreateSection, CreateButton, Toggle, Slider, Dropdown, Input, Keybind, Notify
    -- Tetap sama seperti versi sebelumnya

    return self
end

return IkanTongkol
